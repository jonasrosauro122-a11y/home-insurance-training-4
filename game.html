<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LAVA Classroom ‚Äî Flappy Quiz</title>
<style>
  :root{--accent:#ff1f1f;--bg1:#000;--bg2:#480000}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:'Poppins',sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff;overflow:hidden}
  .site-header{position:fixed;left:0;right:0;top:0;z-index:50;background:rgba(0,0,0,0.65);backdrop-filter:blur(4px)}
  .header-inner.container{max-width:1200px;margin:0 auto;padding:12px 20px;display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;align-items:center;gap:10px;text-decoration:none;color:#fff;font-weight:700}
  .brand img{height:36px}
  .main-nav ul{display:flex;gap:12px;list-style:none;margin:0;padding:0}
  .main-nav a{color:#fff;text-decoration:none;padding:6px 10px;border-radius:6px}
  .main-nav a.active,.main-nav a:hover{background:var(--accent)}
  #gameArea{position:fixed;left:0;right:0;top:64px;bottom:0;display:flex;align-items:center;justify-content:center}
  canvas{border-radius:10px;border:3px solid var(--accent);box-shadow:0 12px 40px rgba(0,0,0,0.6);background:#70c8ff}
  .hud{position:absolute;top:78px;width:100%;text-align:center;pointer-events:none;z-index:40}
  .hud .score{font-size:28px;font-weight:800}
  .hud .high{font-size:12px;color:rgba(255,255,255,0.9)}
  #startPanel{position:absolute;top:38%;left:50%;transform:translateX(-50%);text-align:center;z-index:45}
  #startPanel input{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);width:220px;margin-bottom:8px}
  .btn{padding:10px 16px;border-radius:10px;border:none;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.08)}
  #giveUp{position:absolute;top:76px;right:20px;z-index:45}
  #quizBox{display:none;position:absolute;left:50%;top:22%;transform:translateX(-50%);width:88%;max-width:520px;background:#111;border:2px solid var(--accent);padding:16px;border-radius:12px;z-index:60;text-align:left}
  #quizBox h3{color:#fff;margin:0 0 10px}
  .choices{display:flex;flex-direction:column;gap:8px}
  .choiceBtn{background:#222;color:#fff;border-radius:8px;padding:10px;border:none;cursor:pointer;text-align:left}
  #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:80;align-items:center;justify-content:center}
  #modal .card{background:#0f0f0f;color:#fff;padding:20px;border-radius:12px;width:92%;max-width:520px;border:1px solid rgba(255,255,255,0.06)}
  #modal h2{color:var(--accent);margin:0 0 8px}
  ol.leader{padding-left:18px;margin:8px 0 0;max-height:220px;overflow-y:auto}
  ol.leader li{background:#111;padding:8px;border-radius:8px;margin:6px 0}
  #countText{position:absolute;top:45%;left:50%;transform:translate(-50%,-50%);font-size:100px;font-weight:900;color:var(--accent);pointer-events:none;z-index:70;display:none}
  
  /* üëá New Sidebar for Player List */
  #playerSidebar{
    position:absolute;
    left:20px;
    top:100px;
    background:rgba(0,0,0,0.55);
    border:1px solid var(--accent);
    padding:12px;
    border-radius:10px;
    z-index:50;
    width:180px;
    max-height:400px;
    overflow-y:auto;
  }
  #playerSidebar h4{margin:0 0 8px;font-size:14px;text-align:center;color:var(--accent)}
  #playerSidebar ul{list-style:none;padding:0;margin:0}
  #playerSidebar li{padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.1)}
  
  /* üéÜ Fireworks & Message */
#fireworksMsg{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%,-50%);
    font-size:48px;
    font-weight:900;
    color:#ffdb4d;
    text-shadow:0 0 20px #ff0000,0 0 40px #ff0000;
    display:none;
    animation:popText 2s ease-out forwards;
    z-index:90;
    pointer-events:none; /* ‚úÖ allows the game to continue while text is visible */
}
  @keyframes popText{
    0%{transform:translate(-50%,-50%) scale(0);opacity:0;}
    40%{transform:translate(-50%,-50%) scale(1.3);opacity:1;}
    100%{transform:translate(-50%,-50%) scale(1);opacity:0;}
  }
</style>
</head>
<body>

<header class="site-header">
  <div class="header-inner container">
    <a class="brand" href="index.html"><img src="images/logo.png" alt="LAVA">LAVA Classroom</a>
    <nav class="main-nav" aria-label="main">
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="about.html">Trainers</a></li>
        <li><a href="courses.html">Courses</a></li>
        <li><a href="assignments.html">LAVA University</a></li>
        <li><a href="game.html" class="active">Games</a></li>
        <li><a href="contact.html">Contact</a></li>
      </ul>
    </nav>
  </div>
</header>

<section id="gameArea">
  <canvas id="canvas" width="420" height="630"></canvas>

  <div id="playerSidebar">
    <h4>Insurance VA Players</h4>
    <ul id="sideList"></ul>
  </div>

  <div id="fireworksMsg">Awesome!</div>

  <div class="hud">
    <div class="score" id="scoreLabel">0</div>
    <div class="high" id="highLabel">High: 0</div>
  </div>

  <div id="startPanel">
    <input id="playerName" placeholder="Enter your name" />
    <div><button id="startBtn" class="btn">Start</button></div>
  </div>

  <button id="giveUp" class="btn ghost">Give Up</button>

  <div id="quizBox">
    <h3 id="quizQ">Question</h3>
    <div class="choices" id="choices"></div>
  </div>

  <div id="modal">
    <div class="card">
      <h2>üèÜ LAVA Leaderboard</h2>
      <p id="finalText">Final score: 0</p>
      <ol class="leader" id="leaderList"></ol>
      <div style="margin-top:12px;text-align:center">
        <button id="modalClose" class="btn">Close</button>
        <button id="goDashboard" class="btn ghost">Go to Dashboard</button>
      </div>
    </div>
  </div>

  <div id="countText">3</div>
</section>

<script>
(() => {
  const canvas=document.getElementById('canvas');
  const ctx=canvas.getContext('2d');
  const scoreLabel=document.getElementById('scoreLabel');
  const highLabel=document.getElementById('highLabel');
  const startPanel=document.getElementById('startPanel');
  const playerNameInput=document.getElementById('playerName');
  const giveUpBtn=document.getElementById('giveUp');
  const quizBox=document.getElementById('quizBox');
  const quizQ=document.getElementById('quizQ');
  const choicesWrap=document.getElementById('choices');
  const modal=document.getElementById('modal');
  const leaderList=document.getElementById('leaderList');
  const finalText=document.getElementById('finalText');
  const modalClose=document.getElementById('modalClose');
  const goDashboard=document.getElementById('goDashboard');
  const countText=document.getElementById('countText');
  const sideList=document.getElementById('sideList');
  const fireworksMsg=document.getElementById('fireworksMsg');

  const W=canvas.width,H=canvas.height;
  const birdImg=new Image(); birdImg.src='images/bird.png';
  const pipeImg=new Image(); pipeImg.src='images/pipe.png';
  const bgImg=new Image(); bgImg.src='images/bg.png';

  let bird,pipes,frame,score,high,running,questionActive,gameOver,playerName;
  let safeTimer = 0; // üëà short invincibility period after correct answer
  const gravity=0.40,jump=-6,pipeSpeed=1.2,pipeGap=160,pipeW=52;

const questions = [
  { q: "What is insurance?", a: "It‚Äôs protection against financial loss." },
  { q: "What is a premium?", a: "The amount you pay for insurance coverage." },
  { q: "What is a deductible?", a: "The amount you pay before insurance covers a claim." },
  { q: "What is a claim?", a: "A request to your insurance company for payment." },
  { q: "What does auto insurance cover?", a: "Damage, theft, and liability from car accidents." },
  { q: "What is liability coverage?", a: "It pays for damage or injury you cause to others." },
  { q: "What is collision coverage?", a: "It covers damage to your car from a crash." },
  { q: "What is comprehensive coverage?", a: "It covers damage from non-collision events like theft or fire." },
  { q: "What is uninsured motorist coverage?", a: "It protects you if the other driver has no insurance." },
  { q: "What is health insurance?", a: "It helps pay medical and hospital expenses." },
  { q: "What is life insurance?", a: "It pays money to your family when you die." },
  { q: "What is term life insurance?", a: "Coverage for a specific period of time." },
  { q: "What is whole life insurance?", a: "Lifetime coverage with a savings feature." },
  { q: "What is renters insurance?", a: "It protects personal belongings in a rental home." },
  { q: "What is homeowners insurance?", a: "It covers your house and belongings from damage or loss." },
  { q: "What is personal property coverage?", a: "It protects your belongings inside your home." },
  { q: "What is personal liability insurance?", a: "It covers injuries or damages you cause to others." },
  { q: "What is travel insurance?", a: "It covers trip cancellations, medical, or lost baggage." },
  { q: "What is disability insurance?", a: "It replaces income if you can‚Äôt work due to illness or injury." },
  { q: "What is flood insurance?", a: "It covers water damage from floods." },
  { q: "What is earthquake insurance?", a: "It covers damage caused by earthquakes." },
  { q: "What is medical payments coverage?", a: "It pays medical bills after an auto accident." },
  { q: "What is a beneficiary?", a: "The person who receives insurance benefits." },
  { q: "What is a policy limit?", a: "The maximum amount the insurer will pay." },
  { q: "What is an exclusion?", a: "Something your insurance does not cover." },
  { q: "What is a policyholder?", a: "The person who owns the insurance policy." },
  { q: "What is a lapse?", a: "When your policy ends due to non-payment." },
  { q: "What is a grace period?", a: "Extra time to pay your premium before cancellation." },
  { q: "What is a rider?", a: "An add-on that changes your coverage." },
  { q: "What is replacement cost?", a: "The cost to replace an item with a new one." },
  { q: "What is actual cash value?", a: "The value of an item after depreciation." },
  { q: "What is term in insurance?", a: "The length of time your policy lasts." },
  { q: "What is proof of loss?", a: "A document showing details of a claim." },
  { q: "What is a quote?", a: "An estimate of your insurance cost." },
  { q: "What is a co-pay?", a: "A set amount you pay for a health service." },
  { q: "What is coinsurance?", a: "You pay a percentage of medical costs." },
  { q: "What is an insurance adjuster?", a: "A person who investigates claims." },
  { q: "What is risk?", a: "The chance of loss or damage." },
  { q: "What is underwriting?", a: "The process of evaluating risk before giving insurance." },
  { q: "What is an insurance policy?", a: "The contract between you and the insurer." },

  // üè¢ COMMERCIAL INSURANCE
  { q: "What is commercial insurance?", a: "Insurance that protects businesses." },
  { q: "What is a Business Owners Policy (BOP)?", a: "A package of property and liability insurance for small businesses." },
  { q: "What is general liability insurance?", a: "It covers injury or property damage caused by your business." },
  { q: "What is commercial property insurance?", a: "It covers buildings, equipment, and inventory." },
  { q: "What is workers‚Äô compensation insurance?", a: "It covers employee injuries on the job." },
  { q: "What is professional liability insurance?", a: "It protects against mistakes in professional services." },
  { q: "What is commercial auto insurance?", a: "It covers vehicles used for business." },
  { q: "What is product liability insurance?", a: "It covers harm caused by products you sell or make." },
  { q: "What is cyber liability insurance?", a: "It protects against data breaches and cyberattacks." },
  { q: "What is business interruption insurance?", a: "It covers lost income if your business shuts down temporarily." },
  { q: "What is commercial umbrella insurance?", a: "Extra liability coverage beyond your main policy." },
  { q: "What is directors and officers (D&O) insurance?", a: "It protects company leaders from lawsuits." },
  { q: "What is employment practices liability insurance (EPLI)?", a: "It covers claims of harassment or discrimination." },
  { q: "What is equipment breakdown insurance?", a: "It covers repair or replacement of broken machinery." },
  { q: "What is builders risk insurance?", a: "It covers buildings under construction." },
  { q: "What is inland marine insurance?", a: "It covers property while being transported." },
  { q: "What is cargo insurance?", a: "It covers goods shipped by land, air, or sea." },
  { q: "What is key person insurance?", a: "It covers loss if a vital employee dies or is disabled." },
  { q: "What is fidelity insurance?", a: "It covers losses from employee theft or fraud." },
  { q: "What is surety bond insurance?", a: "It guarantees that a contract or obligation will be completed." }
];

  function loadScores(){try{return JSON.parse(localStorage.getItem('lava_scores')||'[]');}catch(e){return[];}}
  function saveScores(arr){localStorage.setItem('lava_scores',JSON.stringify(arr));}
  
  function updateLeaderModal(){
    const arr=loadScores().sort((a,b)=>b.score-a.score);
    leaderList.innerHTML='';
    arr.forEach((p,i)=>{
      const li=document.createElement('li');
      li.textContent=`${i+1}. ${p.name} ‚Äî ${p.score}`;
      leaderList.appendChild(li);
    });
    sideList.innerHTML='';
    arr.forEach(p=>{
      const li=document.createElement('li');
      li.textContent=`${p.name}: ${p.score}`;
      sideList.appendChild(li);
    });
  }

  function drawBackground(){ctx.drawImage(bgImg,0,0,W,H);}
  function drawPipes(){pipes.forEach(p=>{ctx.drawImage(pipeImg,p.x,p.bottom,pipeW,H-p.bottom);ctx.save();ctx.translate(p.x+pipeW/2,p.top);ctx.scale(1,-1);ctx.drawImage(pipeImg,-pipeW/2,0,pipeW,H-p.bottom);ctx.restore();});}
  function drawBird(){ctx.drawImage(birdImg,bird.x,bird.y,bird.w,bird.h);}

  function spawnPipe(){const top=Math.random()*(H-pipeGap-140)+40;pipes.push({x:W,top:top,bottom:top+pipeGap,passed:false});}

function update(){
  if(!running || questionActive) return;

  frame++;
  bird.vel += gravity;
  bird.y += bird.vel;
  pipes.forEach(p => p.x -= pipeSpeed);

  if(frame % 100 === 0) spawnPipe();
  pipes = pipes.filter(p => p.x + pipeW > -20);
  if(safeTimer > 0) safeTimer--;

  let hitPipe = false;

  pipes.forEach(p => {
    // üü¢ Add to score when passing pipe
    if(!p.passed && p.x + pipeW < bird.x){
      p.passed = true;
      score++;
      scoreLabel.textContent = score;
      if(score > high){
        high = score;
        localStorage.setItem('lava_high', high);
        highLabel.textContent = 'High: ' + high;
      }
      checkFireworks(score); // üéÜ still okay
    }

    // üí• Collision check
    const collide = (
      bird.x + bird.w > p.x &&
      bird.x < p.x + pipeW &&
      (bird.y < p.top || bird.y + bird.h > p.bottom)
    );
    if(collide && safeTimer <= 0) hitPipe = true;
  });

  // üí• Ground/ceiling collision
  if((bird.y < 0 || bird.y + bird.h > H) && safeTimer <= 0) hitPipe = true;

  // üéØ Only trigger quiz if a collision actually happened
  if(hitPipe){
    openQuiz();
  }
}

  function render(){ctx.clearRect(0,0,W,H);drawBackground();drawPipes();drawBird();}
  function loop(){if(running&&!gameOver){update();render();requestAnimationFrame(loop);}}

  function startGame(){
    playerName=(playerNameInput.value||'').trim();
    if(!playerName){alert('Please enter your name');return;}
    const scores=loadScores();
    if(!scores.some(s=>s.name===playerName)){scores.push({name:playerName,score:0});saveScores(scores);}
    resetGame();
    showCountdown(3,()=>{running=true;requestAnimationFrame(loop);});
  }

  function resetGame(){
    bird={x:80,y:H/2,w:34,h:24,vel:0};
    pipes=[];frame=0;score=0;running=false;questionActive=false;gameOver=false;
    scoreLabel.textContent='0';high=parseInt(localStorage.getItem('lava_high')||0);
    highLabel.textContent='High: '+high;
    startPanel.style.display='none';updateLeaderModal();spawnPipe();
  }

  // ‚úÖ RANDOMIZED QUESTION PICKER
  function openQuiz(){
    running=false;questionActive=true;
    const randomQ = questions[Math.floor(Math.random()*questions.length)];
    quizQ.textContent=randomQ.q;
    const choices=new Set([randomQ.a]);
    while(choices.size<3)choices.add(questions[Math.floor(Math.random()*questions.length)].a);
    const arr=[...choices].sort(()=>Math.random()-0.5);
    choicesWrap.innerHTML='';
    arr.forEach(txt=>{
      const btn=document.createElement('button');
      btn.className='choiceBtn';btn.textContent=txt;
      btn.onclick=()=>handleAnswer(txt,randomQ.a);
      choicesWrap.appendChild(btn);
    });
    quizBox.style.display='block';
  }

  // ‚úÖ Pause ‚Üí Answer ‚Üí Resume OR End Game
  function handleAnswer(ans,correct){
    quizBox.style.display='none';
    if(ans.toLowerCase()===correct.toLowerCase()){
      // correct
      questionActive=false;
      running=true;
      bird.vel=jump;
      safeTimer = 60; // üëà ~1 second of safe time to fly away from pipe
      requestAnimationFrame(loop);
    } else {
      // wrong answer
      endGame();
    }
  }

  function showCountdown(sec,cb){
    countText.style.display='block';let c=sec;
    countText.textContent=c;
    const timer=setInterval(()=>{c--;if(c>0)countText.textContent=c;else{clearInterval(timer);countText.style.display='none';cb();}},1000);
  }

  // üéÜ Fireworks Pop Message
  function checkFireworks(s){
    if(s===10){showFireworks("Awesome!");}
    if(s===15){showFireworks("You are Insurance VA Expert!");}
  }

  function showFireworks(msg){
    fireworksMsg.textContent=msg;
    fireworksMsg.style.display='block';
    setTimeout(()=>{fireworksMsg.style.display='none';},3000);
  }

// üèÅ End Game
async function endGame() {
  gameOver = true;
  running = false;

  const scores = loadScores();
  const existing = scores.find(s => s.name === playerName);
  if (existing) existing.score = Math.max(existing.score, score);
  else scores.push({ name: playerName, score });
  saveScores(scores);

  // üß© Save to Supabase leaderboard
  try {
    const SUPABASE_URL = "https://YOUR-PROJECT.supabase.co"; // üîÅ replace with your real project URL
    const SUPABASE_KEY = "YOUR-ANON-PUBLIC-KEY"; // üîÅ replace with your anon key
    const { createClient } = await import("https://esm.sh/@supabase/supabase-js@2");
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // Check if player already exists in Supabase
    const { data: existingRows } = await supabase
      .from("scores")
      .select("*")
      .eq("name", playerName)
      .single();

    if (existingRows) {
      // Update if higher score
      if (score > existingRows.score) {
        await supabase
          .from("scores")
          .update({ score })
          .eq("name", playerName);
      }
    } else {
      // Insert new player
      await supabase.from("scores").insert([{ name: playerName, score }]);
    }

  } catch (err) {
    console.error("Error saving score to Supabase:", err);
  }

  finalText.textContent = "Final score: " + score;
  updateLeaderModal();
  modal.style.display = "flex";
}

  giveUpBtn.onclick=()=>endGame();
  modalClose.onclick=()=>{modal.style.display='none';startPanel.style.display='';};
  goDashboard.onclick=()=>window.location.href='game.html';
  document.getElementById('startBtn').onclick=startGame;
  canvas.onclick=()=>{if(running&&!questionActive)bird.vel=jump;};
  window.onkeydown=e=>{if(e.code==='Space'&&running&&!questionActive)bird.vel=jump;};

  highLabel.textContent='High: '+(localStorage.getItem('lava_high')||0);
  updateLeaderModal();
})();
</script>
</body>
</html>
